name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      ref:
        description: 'Git ref to deploy (branch, tag, or commit SHA)'
        required: true
        default: 'main'
        type: string

env:
  AWS_REGION: us-east-1
  ENVIRONMENT: prod

jobs:
  build:
    name: Build Production Artifacts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Node dependencies
        run: npm ci

      - name: Install Python dependencies
        run: |
          cd services/ai-processor
          pip install -r requirements.txt

      - name: Run linting
        run: npm run lint

      - name: Run type checking
        run: npm run typecheck

      - name: Run tests
        run: npm run test --workspaces --if-present

      - name: Run Python tests
        run: |
          cd services/ai-processor
          pytest

      - name: Build API Lambda
        run: |
          chmod +x scripts/build-api.sh
          bash scripts/build-api.sh

      - name: Build AI Lambda
        run: |
          chmod +x scripts/build-ai.sh
          bash scripts/build-ai.sh

      - name: Build Collaboration Lambda
        run: |
          chmod +x scripts/build-collaboration.sh
          bash scripts/build-collaboration.sh

      - name: Build Frontend
        run: |
          chmod +x scripts/build-frontend.sh
          bash scripts/build-frontend.sh
        env:
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL_PROD }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: production-artifacts
          path: |
            deploy/api-lambda.zip
            deploy/ai-lambda.zip
            deploy/collaboration-lambda.zip
            frontend/dist
          retention-days: 30

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: production
      url: https://demand-letters.example.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - name: Download production artifacts
        uses: actions/download-artifact@v4
        with:
          name: production-artifacts
          path: .

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_PROD }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_PROD }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify AWS credentials
        run: aws sts get-caller-identity

      - name: Send Slack notification (deployment started)
        if: always()
        run: |
          chmod +x .github/scripts/notify-slack.sh
          .github/scripts/notify-slack.sh started prod "Production deployment started for ref: ${{ inputs.ref }}"
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true

      - name: Run database migrations
        run: |
          chmod +x scripts/run-migrations.sh
          bash scripts/run-migrations.sh prod
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_PROD }}

      - name: Deploy API Lambda
        run: |
          chmod +x scripts/deploy-lambda.sh
          bash scripts/deploy-lambda.sh api prod deploy/api-lambda.zip

      - name: Deploy AI Lambda
        run: |
          chmod +x scripts/deploy-lambda.sh
          bash scripts/deploy-lambda.sh ai prod deploy/ai-lambda.zip

      - name: Deploy Collaboration Lambda
        run: |
          chmod +x scripts/deploy-lambda.sh
          bash scripts/deploy-lambda.sh collaboration prod deploy/collaboration-lambda.zip

      - name: Deploy Frontend
        run: |
          chmod +x scripts/deploy-frontend.sh
          bash scripts/deploy-frontend.sh prod
        env:
          WAIT_FOR_INVALIDATION: "true"

      - name: Run comprehensive smoke tests
        run: |
          chmod +x scripts/smoke-test.sh
          bash scripts/smoke-test.sh prod
        env:
          API_BASE_URL_PROD: ${{ secrets.API_BASE_URL_PROD }}
          FRONTEND_URL_PROD: ${{ secrets.FRONTEND_URL_PROD }}

      - name: Tag deployment
        run: |
          DEPLOY_TAG="prod-$(date -u +%Y%m%d-%H%M%S)-$(git rev-parse --short HEAD)"
          git tag "$DEPLOY_TAG"
          git push origin "$DEPLOY_TAG" || echo "Failed to push tag (non-fatal)"

      - name: Create deployment annotation in CloudWatch
        run: |
          DEPLOY_TAG="prod-$(date -u +%Y%m%d-%H%M%S)-$(git rev-parse --short HEAD)"
          aws cloudwatch put-metric-data \
            --namespace "DemandLetters/Deployments" \
            --metric-name "Deployment" \
            --value 1 \
            --dimensions Environment=prod,Version="$DEPLOY_TAG"

      - name: Send Slack notification (success)
        if: success()
        run: |
          chmod +x .github/scripts/notify-slack.sh
          .github/scripts/notify-slack.sh success prod "Production deployment completed successfully for ref: ${{ inputs.ref }}"
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true

      - name: Send Slack notification (failure)
        if: failure()
        run: |
          chmod +x .github/scripts/notify-slack.sh
          .github/scripts/notify-slack.sh failure prod "Production deployment FAILED for ref: ${{ inputs.ref }}"
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true

      - name: Trigger rollback instructions
        if: failure()
        run: |
          echo "::warning::Deployment failed! To rollback, run: .github/workflows/rollback.yml"
          echo "::warning::Or manually execute: bash scripts/rollback.sh all prod"
